<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</title>
  
  <!-- Font: Prompt -->
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Prompt', 'sans-serif'],
          },
          colors: {
            terracotta: {
              300: '#ff8c73', // Light orange
              500: '#e0664d', // Base
              700: '#cc4e33', // Darker
            }
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #f8f9fa;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f1f1; }
    ::-webkit-scrollbar-thumb { background: #e0664d; border-radius: 10px; }

    /* Soft Shadow & Cards */
    .soft-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
    }
    .soft-card:active { transform: scale(0.98); }

    /* Status Badges */
    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-pending { background-color: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
    .status-approved { background-color: #f0fdf4; color: #15803d; border: 1px solid #dcfce7; }
    .status-rejected { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fee2e2; }

    /* Loading Spinner */
    .loader {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #e0664d;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="text-gray-700 min-h-screen flex flex-col">

  <!-- Header: ‡∏ó‡∏£‡∏á‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° -->
  <header class="bg-gradient-to-r from-terracotta-700 to-terracotta-300 text-white p-5 shadow-lg sticky top-0 z-50">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-xl font-semibold">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤</h1>
        <p class="text-xs opacity-90 font-light mt-1">‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ HR ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</p>
      </div>
      <div id="user-avatar" class="hidden">
        <img id="avatar-img" src="" class="w-10 h-10 rounded-full border-2 border-white shadow-sm">
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow p-4 max-w-lg mx-auto w-full">
    
    <!-- Loading State -->
    <div id="loading" class="flex flex-col items-center justify-center py-20">
      <div class="loader mb-4"></div>
      <p class="text-terracotta-500 font-medium animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <!-- Error State -->
    <div id="error-screen" class="hidden text-center py-10">
      <div class="text-6xl mb-4">üòï</div>
      <h3 class="text-lg font-bold text-gray-800">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</h3>
      <p id="error-msg" class="text-sm text-gray-500 mt-2 px-4"></p>
    </div>

    <!-- Content Container -->
    <div id="content" class="hidden space-y-4">
      <!-- Profile Summary -->
      <div class="soft-card p-4 flex items-center space-x-4 mb-6">
        <div class="flex-1">
          <p class="text-xs text-gray-400">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏∏‡∏ì</p>
          <h2 id="emp-name" class="text-lg font-bold text-terracotta-700"></h2>
          <p id="emp-pos" class="text-sm text-gray-500"></p>
        </div>
      </div>

      <!-- PAGE 1: HISTORY -->
      <div id="view-history" class="hidden">
        <h3 class="text-md font-semibold text-gray-800 mb-3 border-l-4 border-terracotta-500 pl-3">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
        <div id="history-list" class="space-y-3"></div>
      </div>

      <!-- PAGE 2: BALANCE -->
      <div id="view-balance" class="hidden">
        <h3 class="text-md font-semibold text-gray-800 mb-3 border-l-4 border-terracotta-500 pl-3">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</h3>
        <div id="balance-container" class="space-y-4"></div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="p-6 text-center text-xs text-gray-400 mt-auto">
    <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥<br>‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö HR ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
  </footer>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 w-full max-w-sm">
        <div class="bg-gradient-to-r from-terracotta-700 to-terracotta-300 px-4 py-3">
          <h3 class="text-white font-semibold" id="modal-title">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡∏•‡∏≤</h3>
        </div>
        <div class="px-4 py-5 sm:p-6 space-y-3 text-sm" id="modal-content"></div>
        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
          <button type="button" class="inline-flex w-full justify-center rounded-xl bg-gray-200 px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm hover:bg-gray-300 sm:ml-3 sm:w-auto" onclick="closeModal()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const LIFF_ID = '2008647384-Oy59agYa';
    
    // ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ Action ‡πÅ‡∏ö‡∏ö‡∏ï‡∏£‡∏á‡πÑ‡∏õ‡∏ï‡∏£‡∏á‡∏°‡∏≤ (Strict)
    let currentAction = 'history'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    try {
        const serverAction = '<?= action ?>';
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô string ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ '?' (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏à‡∏≤‡∏Å PHP tags ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•)
        if (serverAction && typeof serverAction === 'string' && !serverAction.includes('?')) {
            currentAction = serverAction;
        }
    } catch (e) {}
    
    console.log('Current Action:', currentAction); // Log ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Debug ‡∏î‡∏π‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    // ----------------------------------------

    async function main() {
      try {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SDK
        if (typeof liff === 'undefined') {
            throw new Error('LIFF SDK ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)');
        }

        // Initialize LIFF
        await liff.init({ liffId: LIFF_ID });
        
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        
        // ‡∏™‡πà‡∏á userId ‡πÅ‡∏•‡∏∞ action ‡πÑ‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
        fetchData(profile.userId, currentAction);

      } catch (err) {
        console.error('LIFF Init Error:', err);
        let errorText = err.message;
        if(errorText.includes('channel not found')) errorText = '‡πÑ‡∏°‡πà‡∏û‡∏ö LIFF Channel ‡∏ô‡∏µ‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID)';
        showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE: ' + errorText);
      }
    }

    function fetchData(uid, action) {
      if (typeof google !== 'undefined' && google.script) {
          google.script.run
            .withSuccessHandler(renderApp)
            .withFailureHandler((e) => showError('System Error: ' + e.message))
            .getUserData(uid, action);
      } else {
          // Fallback for Local Dev
          showError('Google Script Environment not detected.');
      }
    }

    function renderApp(response) {
      document.getElementById('loading').classList.add('hidden');
      
      if (response.status === 'error') {
        showError(response.message);
        return;
      }

      const emp = response.employee;
      const data = response.data;
      const bal = response.balance;

      // Show UI
      document.getElementById('content').classList.remove('hidden');
      document.getElementById('user-avatar').classList.remove('hidden');
      document.getElementById('avatar-img').src = emp.image || 'https://via.placeholder.com/150';
      document.getElementById('emp-name').textContent = emp.fullName + ' (' + emp.nickname + ')';
      document.getElementById('emp-pos').textContent = emp.position + ' - ' + emp.dept;

      // Render View based on action
      if (response.type === 'history') {
        renderHistory(data);
      } else if (response.type === 'balance') {
        renderBalance(emp.rights, emp.used, bal);
      } else {
        showError(`‡πÑ‡∏°‡πà‡∏û‡∏ö Action: "${currentAction}" ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏ô Rich Menu`);
      }
    }

    function renderHistory(list) {
      document.getElementById('view-history').classList.remove('hidden');
      const container = document.getElementById('history-list');
      
      if (!list || list.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8 bg-white rounded-xl border border-dashed border-gray-300">
            <p class="text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</p>
          </div>`;
        return;
      }

      let html = '';
      list.forEach((item) => {
        let statusClass = 'status-pending';
        const status = (item.status || '').toString();
        if (status.includes('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') && !status.includes('‡πÑ‡∏°‡πà')) statusClass = 'status-approved';
        if (status.includes('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') || status.includes('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å') || status.includes('‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô')) statusClass = 'status-rejected';

        html += `
        <div class="soft-card p-4 relative overflow-hidden">
          <div class="absolute top-0 right-0 w-2 h-full ${statusClass === 'status-approved' ? 'bg-green-500' : 'bg-terracotta-500'} opacity-10"></div>
          <div class="flex justify-between items-start mb-2">
            <div>
              <span class="text-xs text-gray-400">#${item.reqNo}</span>
              <h4 class="font-semibold text-gray-800">${item.type}</h4>
            </div>
            <span class="status-badge ${statusClass}">${item.status || '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'}</span>
          </div>
          <div class="flex justify-between items-end">
            <div class="text-sm text-gray-600">
              <p><span class="text-gray-400">‡πÄ‡∏£‡∏¥‡πà‡∏°:</span> ${formatDate(item.startDate)}</p>
              <p><span class="text-gray-400">‡∏ñ‡∏∂‡∏á:</span> ${formatDate(item.endDate)}</p>
            </div>
            <button onclick='openDetail(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="bg-terracotta-500 text-white text-xs px-3 py-2 rounded-lg shadow-md hover:bg-terracotta-700 transition active:scale-95">
              ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
            </button>
          </div>
        </div>`;
      });
      container.innerHTML = html;
    }

    function renderBalance(rights, used, remain) {
      document.getElementById('view-balance').classList.remove('hidden');
      const container = document.getElementById('balance-container');
      
      const createCard = (title, right, use, left, icon) => `
        <div class="soft-card p-5">
          <div class="flex items-center space-x-3 mb-3">
            <div class="w-8 h-8 rounded-full bg-terracotta-300 bg-opacity-20 flex items-center justify-center text-lg">${icon}</div>
            <h4 class="font-bold text-gray-700">${title}</h4>
          </div>
          <div class="grid grid-cols-3 gap-2 text-center divide-x divide-gray-100">
            <div><p class="text-xs text-gray-400">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</p><p class="font-semibold text-lg text-gray-800">${right}</p></div>
            <div><p class="text-xs text-gray-400">‡πÉ‡∏ä‡πâ</p><p class="font-semibold text-lg text-terracotta-500">${use}</p></div>
            <div><p class="text-xs text-gray-400">‡πÄ‡∏´‡∏•‡∏∑‡∏≠</p><p class="font-bold text-xl text-green-600">${left}</p></div>
          </div>
        </div>`;

      container.innerHTML = 
        createCard('‡∏•‡∏≤‡∏Å‡∏¥‡∏à', rights.biz, used.biz, remain.biz, 'üëú') +
        createCard('‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', rights.sick, used.sick, remain.sick, 'ü§í') +
        createCard('‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô', rights.vacation, used.vacation, remain.vacation, 'üèñÔ∏è');
    }

    function openDetail(item) {
      const modal = document.getElementById('modal');
      const content = document.getElementById('modal-content');
      content.innerHTML = `
        <div class="grid grid-cols-3 gap-2 text-gray-600">
          <div class="col-span-1 font-medium text-gray-400">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</div><div class="col-span-2 text-gray-800">${item.reqNo}</div>
          <div class="col-span-1 font-medium text-gray-400">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</div><div class="col-span-2 text-gray-800">${item.type}</div>
          <div class="col-span-1 font-medium text-gray-400">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div><div class="col-span-2 text-gray-800">${formatDate(item.startDate)} - ${formatDate(item.endDate)}</div>
          <div class="col-span-1 font-medium text-gray-400">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</div><div class="col-span-2 text-gray-800">${item.reason || '-'}</div>
          <div class="col-span-3 border-t my-2"></div>
          <div class="col-span-1 font-medium text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</div><div class="col-span-2 font-bold text-terracotta-700">${item.status}</div>
          <div class="col-span-1 font-medium text-gray-400">‡∏´‡∏ô./HR</div><div class="col-span-2 text-sm">${item.bossNote || '-'}/${item.hrMemo || '-'}</div>
        </div>`;
      modal.classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    function showError(msg) {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error-screen').classList.remove('hidden');
      document.getElementById('error-msg').innerHTML = msg;
    }
    function formatDate(d) { return d ? d.split(' ')[0] : "-"; }

    main();
  </script>
</body>
</html>
