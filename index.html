const SSID = "10S3cWJDWObPYvkUMdimS_Ilm0oxIDIdpH-sznWzoolQ"; // ID ของ Google Sheet

// เพิ่มฟังก์ชัน doGet เพื่อแก้ปัญหา Script function not found: doGet
function doGet(e) {
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  // ส่งข้อความกลับไปบอกว่า API ทำงานอยู่
  return output.setContent(JSON.stringify({ 
    status: "success", 
    message: "API is running. Please use POST method to fetch data." 
  }));
}

function doPost(e) {
  // แก้ปัญหา CORS และตั้งค่า Output เป็น JSON
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);

  try {
    // ตรวจสอบว่ามีข้อมูลส่งมาหรือไม่
    if (!e.postData || !e.postData.contents) {
      throw new Error("ไม่พบข้อมูล Post Data");
    }

    // รับข้อมูล Parameter จาก Frontend
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const lineId = data.lineId;

    if (!lineId) throw new Error("ไม่พบ Line ID");

    const ss = SpreadsheetApp.openById(SSID);
    
    // 1. ดึงข้อมูลพนักงานจาก LineID
    const employeeSheet = ss.getSheetByName("พนักงาน");
    if (!employeeSheet) throw new Error("ไม่พบ Sheet 'พนักงาน'");

    const empData = employeeSheet.getDataRange().getValues();
    // Headers: LineID(0), Email(1), HeadEmail(2), Prefix(3), Name(4), Surname(5)...
    
    let empRow = null;
    let empEmail = "";
    
    for (let i = 1; i < empData.length; i++) {
      // แปลงเป็น String เพื่อป้องกัน Error หาก Cell เป็นตัวเลข
      if (String(empData[i][0]) === String(lineId)) {
        empRow = empData[i];
        empEmail = empData[i][1]; // Email พนักงาน
        break;
      }
    }

    if (!empRow) {
      return output.setContent(JSON.stringify({ status: "error", message: "ไม่พบข้อมูลพนักงานในระบบ (LineID ไม่ตรง)" }));
    }

    // สร้าง Object ข้อมูลพนักงาน
    const empObj = {
      lineId: empRow[0],
      email: empRow[1],
      fullName: `${empRow[3]}${empRow[6]} ${empRow[7]}`, // Title + Name + Surname
      position: empRow[9],
      department: empRow[10],
      rights: {
        personal: empRow[12] || 0, // สิทธิลากิจ
        sick: empRow[13] || 0,     // สิทธิลาป่วย
        vacation: empRow[14] || 0  // สิทธิพักร้อน
      },
      used: {
        personal: empRow[15] || 0, // ลากิจที่ใช้ไป (อนุมัติแล้ว)
        sick: empRow[16] || 0,     // ลาป่วยที่ใช้ไป (อนุมัติแล้ว)
        vacation: empRow[17] || 0  // ลาพักร้อนที่ใช้ไป (อนุมัติแล้ว)
      }
    };

    // --- CASE 1: ขอประวัติใบลา (history) ---
    if (action === "history") {
      const reqSheet = ss.getSheetByName("ใบคำขอ");
      if (!reqSheet) throw new Error("ไม่พบ Sheet 'ใบคำขอ'");
      
      const reqData = reqSheet.getDataRange().getDisplayValues(); // ใช้ DisplayValues เพื่อให้วันที่เป็น String
      const history = [];

      // Loop หาใบลาที่ Email ตรงกับพนักงานคนนี้
      // Headers Request: Timestamp(0), ReqID(1), Email(2)...
      for (let i = 1; i < reqData.length; i++) {
        if (reqData[i][2] === empEmail) {
          history.push({
            timestamp: reqData[i][0],
            reqId: reqData[i][1],
            email: reqData[i][2],
            fullName: reqData[i][3],
            position: reqData[i][4],
            dept: reqData[i][5],
            startDate: reqData[i][6],
            endDate: reqData[i][7],
            type: reqData[i][8],
            reason: reqData[i][9],
            docs: reqData[i][10],
            status: reqData[i][11],
            managerNote: reqData[i][14], // หัวหน้า-บันทึก
            hrMemo: reqData[i][17],      // HR-Memo
            totalDays: reqData[i][18],
            rightsPersonal: reqData[i][19], // สิทธิลากิจ ณ วันที่ขอ
            rightsSick: reqData[i][20],     // สิทธิลาป่วย ณ วันที่ขอ
            rightsVacation: reqData[i][21]  // สิทธิลาพักร้อน ณ วันที่ขอ
          });
        }
      }

      // เรียงลำดับตาม ReqID
      history.sort((a, b) => (a.reqId > b.reqId ? 1 : -1));

      return output.setContent(JSON.stringify({
        status: "success",
        data: history,
        empInfo: empObj
      }));
    }

    // --- CASE 2: ขอสิทธิการลา (balance) ---
    else if (action === "balance") {
      // คำนวณคงเหลือ
      const remaining = {
        personal: empObj.rights.personal - empObj.used.personal,
        sick: empObj.rights.sick - empObj.used.sick,
        vacation: empObj.rights.vacation - empObj.used.vacation
      };

      // สร้างข้อมูลสำหรับแสดงผล Flex Message
      const flexData = {
        employee: empObj.fullName,
        position: empObj.position,
        department: empObj.department,
        details: [
          { label: "ลากิจ", total: empObj.rights.personal, used: empObj.used.personal, remain: remaining.personal },
          { label: "ลาป่วย", total: empObj.rights.sick, used: empObj.used.sick, remain: remaining.sick },
          { label: "พักร้อน", total: empObj.rights.vacation, used: empObj.used.vacation, remain: remaining.vacation }
        ]
      };

      return output.setContent(JSON.stringify({
        status: "success",
        type: "flex",
        data: flexData
      }));
    }

    else {
      return output.setContent(JSON.stringify({ status: "error", message: "Action ไม่ถูกต้อง" }));
    }

  } catch (error) {
    return output.setContent(JSON.stringify({ status: "error", message: error.toString() }));
  }
}
